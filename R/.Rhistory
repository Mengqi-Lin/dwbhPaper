thra <- fill_int_general(nrejs, avals)
## 0 rejection should return aval = 0
thra[thra == 0] <- NA
thra <- avals[thra]
thra[is.na(thra)] <- 0
} else if (avals_type == "bonf"){
thra <- rep(1, length(nrejs))
}
thr <- qnorm(thra * alpha0 * weight / n / ntails, lower.tail = FALSE)
knots_lo <- head(knots, -1)
knots_hi <- tail(knots, -1)
nrejs <- nrejs + ((knots_lo + knots_hi) / 2 < thr)
list(knots = knots, nrejs = nrejs)
})
## Combine two RBH functions
res <- RBHfun_combine(res_q, res_alpha0)
## Compute conditional expectation
expt <- sapply(res, function(re){
compute_cond_exp(abs(zstat), re$knots, re$nrejs, re$thr, dist = pnorm)
})
expt <- sum(expt)
ifrej <- (expt <= alpha * weight / n)
if (verbose){
setTxtProgressBar(pb, id / ncands)
}
#return(c(ifrej, expt))
return(c(ifrej, initrej, expt, Rinit, weight))
})
rownames(cand_info) <- c("ifrej", "ifrej_init", "exp", "Rinit", "weight")
ifrej <- as.logical(cand_info[1, ])
rejindex <- which(ifrej)
rejlist <- cand[rejindex]
rejthoCal <- cand_info[2, ]
expt <- cand_info[3, ]
Rinit <- cand_info[4, ]
weights <- cand_info[5, ]
weights
Rinit
max(Rinit[rejindex])
Rplus
source('~/Documents/GitHub/dbh/R/dBH_mvgauss_qc_optimal.R')
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
qcap = 2,
lfdrinv_type = "lin_exp")
source('~/Documents/GitHub/dbh/R/dBH_mvgauss_qc_optimal.R')
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
qcap = 2,
lfdrinv_type = "lin_exp")
Rplus
rejlist
max(Rinit[rejindex])
ifrej
which(ifrej)
cand[rejindex]
cand_info
cand_info[1, ]
#925  926 1015 1016 1017 1018 1083 1084
source('~/Documents/GitHub/dbh/R/dBH_mvgauss_qc_optimal.R')
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
qcap = 2,
lfdrinv_type = "lin_exp")
id
i
plot(weights)
unique(weights)
qval
qcap
alpha
qval > qcap * alpha
#925  926 1015 1016 1017 1018 1083 1084
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
qcap = 4,
lfdrinv_type = "lin_exp")
qval > qcap * alpha
qcap * alpha
qval
i
id
#925  926 1015 1016 1017 1018 1083 1084
source('~/Documents/GitHub/dbh/R/dBH_mvgauss_qc_optimal.R')
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
qcap = 4,
lfdrinv_type = "lin_exp")
#925  926 1015 1016 1017 1018 1083 1084
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
qcap = 4,
lfdrinv_type = "lin_exp")
#925  926 1015 1016 1017 1018 1083 1084
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
qcap = 10,
lfdrinv_type = "lin_exp")
#925  926 1015 1016 1017 1018 1083 1084
source('~/Documents/GitHub/dbh/R/dBH_mvgauss_qc_optimal.R')
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
qcap = 4,
lfdrinv_type = "lin_exp")
Rnit
Rplus
max(Rinit[rejindex])
Rplus
max(Rinit[rejindex])
cand_info
source('~/Documents/GitHub/dbh/R/dBH_mvgauss_qc_optimal.R')
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
qcap = 4,
lfdrinv_type = "lin_exp")
id
length(cand)
#925  926 1015 1016 1017 1018 1083 1084
source('~/Documents/GitHub/dbh/R/dBH_mvgauss_qc_optimal.R')
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
qcap = 4,
lfdrinv_type = "lin_exp")
#925  926 1015 1016 1017 1018 1083 1084
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
qcap = 4,
lfdrinv_type = "lin_exp")
Rplus
rejlist
Rinit[rejindex]
weights[rejindex]
cand_info
#925  926 1015 1016 1017 1018 1083 1084
is_safe = T
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
is_safe = T,
qcap = 4,
lfdrinv_type = "lin_exp")
Rplus
Rinit[rejindex]
#925  926 1015 1016 1017 1018 1083 1084
source('~/Documents/GitHub/dbh/R/dBH_mvgauss_qc_optimal.R')
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
is_safe = T,
qcap = 4,
lfdrinv_type = "lin_exp")
Rplus
Rinit
Rinit[rejindex]
#925  926 1015 1016 1017 1018 1083 1084
source('~/Documents/GitHub/dbh/R/dBH_mvgauss_qc_optimal.R')
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
is_safe = T,
qcap = 4,
lfdrinv_type = "lin_exp")
i
source('~/Documents/GitHub/dbh/R/dBH_mvgauss_qc_optimal.R')
i
#925  926 1015 1016 1017 1018 1083 1084
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
is_safe = T,
qcap = 4,
lfdrinv_type = "lin_exp")
#925  926 1015 1016 1017 1018 1083 1084
source('~/Documents/GitHub/dbh/R/dBH_mvgauss_qc_optimal.R')
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
is_safe = T,
qcap = 4,
lfdrinv_type = "lin_exp")
#925  926 1015 1016 1017 1018 1083 1084
source('~/Documents/GitHub/dbh/R/dBH_mvgauss_qc_optimal.R')
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
is_safe = T,
qcap = 4,
lfdrinv_type = "lin_exp")
Rinit
ifrej
#925  926 1015 1016 1017 1018 1083 1084
source('~/Documents/GitHub/dbh/R/dBH_mvgauss_qc_optimal.R')
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
is_safe = T,
qcap = 4,
lfdrinv_type = "lin_exp")
#925  926 1015 1016 1017 1018 1083 1084
source('~/Documents/GitHub/dbh/R/dBH_mvgauss_qc_optimal.R')
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
is_safe = T,
qcap = 4,
lfdrinv_type = "lin_exp")
#925  926 1015 1016 1017 1018 1083 1084
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 0.9,
niter = 1,
tautype = "QC",
avals_type = "BH",
is_safe = T,
qcap = 4,
lfdrinv_type = "lin_exp")
#925  926 1015 1016 1017 1018 1083 1084
pvals <- zvals_pvals(zvals, side)
unique(weights)
unique(init_weights)
BH(pvals/init_weights, reshape = FALSE)
which(init_weights<2)[1]
extweights <- c(rep(11, 100), rep(0, 1000))
BH(pvals/extweights, reshape = FALSE)
n_g[1]
BH_vs_weights <- function(w1){
w2 = 11-w1
w <- c(rep(w1, n_g[1]), rep(w2, n_g[2]))
return(BH(pvals/w, reshape = FALSE)$nrejs)
}
plot(BH_vs_weights)
curve(BH_vs_weights)
x
plot(BH_vs_weights)
curve(BH_vs_weights, from = 10, to = 11)
BH_vs_weights(11)
BH_vs_weights(10)
plot(BH_vs_weights, from = 10, to = 11)
plot(BH_vs_weights, from = 10, to = 11)
x <- seq(10, 11, length.out = 0.01)
plot(x, BH_vs_weights(x))
x
x <- seq(from = 10, to = 11, length.out = 0.01)
plot(x, BH_vs_weights(x))
x
x <- seq(from = 10, to = 11, length.out = 20)
plot(x, BH_vs_weights(x))
x
BH_vs_weights <- Vectorize(BH_vs_weights)
x <- seq(from = 10, to = 11, length.out = 20)
plot(x, BH_vs_weights(x))
x <- seq(from = 10, to = 11, length.out = 200)
plot(x, BH_vs_weights(x))
source('~/Documents/GitHub/dbh/R/dBH_mvgauss_qc_optimal.R')
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
qcap = 4,
lfdrinv_type = "lin_exp")
#925  926 1015 1016 1017 1018 1083 1084
source('~/Documents/GitHub/dbh/R/dBH_mvgauss_qc_optimal.R')
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
qcap = 4,
lfdrinv_type = "lin_exp")
#925  926 1015 1016 1017 1018 1083 1084
source('~/Documents/GitHub/dbh/R/dBH_mvgauss_qc_optimal.R')
dBH_mvgauss(zvals = ZVALS[[5]],
Sigma = Sigma,
side = c("right"),
covariates = groups,
weight_type = "optimal",
MC = 10,
alpha = 0.05, gamma = 1,
niter = 1,
tautype = "QC",
avals_type = "BH",
qcap = 4,
lfdrinv_type = "lin_exp")
#925  926 1015 1016 1017 1018 1083 1084
set.seed(1)
res
source("~/Documents/GitHub/dbh/R/compute_knots_mvgauss.R")
source("~/Documents/GitHub/dbh/R/dBH_mvgauss.R")
source("~/Documents/GitHub/dbh/R/dBH_mvgauss_qc.R" )
source("~/Documents/GitHub/dbh/R/adapOptimal_weights.R")
source("~/Documents/GitHub/dbh/R/dBH_mvgauss_qc_optimal.R")
source("~/Documents/GitHub/dbh/R/dBH_utils.R")
library(Rcpp)
sourceCpp("~/Documents/GitHub/dbh/src/RBH_homotopy.cpp")
source("expr_functions.R")
source("plot_function.R")
n_g = c(5000, 500)/5
MC = 1
alphas = seq(0.01, 0.1, length.out = 10)
skip_dBH2 = T
gamma = 1
weight_type = c("trivial", "optimal")
nreps = 100
## Different combinations of mu1 and pi1
MU1 <- matrix(c(1, 2.5, 2, 2, 1, 3), 2)
Pi1 <- matrix(c(0.1, 0.1, 0.01, 0.2, 0.01, 0.2), 2)
set.seed(1)
res <- lapply(1:3, function(i){
dwBH_mvgauss_groups_expr(
n_g = n_g,
mu1_g = MU1[, i],
pi1_g = Pi1[, i],
rho = 0.8,
Sigma_type = "AR",
side = "right",
alphas = alphas,
nreps = nreps,
MC = MC,
weight_type = weight_type,
gamma = 1,
tautype = "QC",
skip_dBH2 = skip_dBH2
)
})
MC = 10
set.seed(1)
res <- lapply(1:3, function(i){
dwBH_mvgauss_groups_expr(
n_g = n_g,
mu1_g = MU1[, i],
pi1_g = Pi1[, i],
rho = 0.8,
Sigma_type = "AR",
side = "right",
alphas = alphas,
nreps = nreps,
MC = MC,
weight_type = weight_type,
gamma = 1,
tautype = "QC",
skip_dBH2 = skip_dBH2
)
})
x <- seq(from = 10, to = 11, length.out = 200)
plot(x, BH_vs_weights(x))
BH_vs_weights <- function(w1){
w2 = 11-w1
w <- c(rep(w1, n_g[1]), rep(w2, n_g[2]))
return(BH(pvals/w, reshape = FALSE)$nrejs)
}
BH_vs_weights <- Vectorize(BH_vs_weights)
x <- seq(from = 10, to = 11, length.out = 200)
plot(x, BH_vs_weights(x))
